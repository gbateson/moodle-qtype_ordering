define(["jquery",require.specified("core/dragdrop")?"core/dragdrop":"qtype_ordering/dragdrop",require.specified("core/key_codes")?"core/key_codes":"qtype_ordering/key_codes"],function(a,b,c){return function(d){var e=null,f=null,g=null,h=null,i=null,j=function(c,h){e={time:(new Date).getTime(),x:h.x,y:h.y},g=a(c.currentTarget).closest(d.itemInPage),"undefined"!=typeof d.reorderStart&&d.reorderStart(g.closest(d.list),g),f=s(),i=a(d.proxyHtml.replace("%%ITEM_HTML%%",g.html()).replace("%%ITEM_CLASS_NAME%%",g.attr("class"))),a(document.body).append(i),i.css("position","absolute"),i.css(g.offset()),i.width(g.outerWidth()),i.height(g.outerHeight()),g.addClass(d.itemMovingClass),l(g),b.start(c,i,k,n)},k=function(){var b=g.closest(d.list),c=null,e=null;b.find(d.item).each(function(b,d){var f=r(d,i);(null===c||f<e)&&(c=a(d),e=f)}),c[0]!==g[0]&&(q(i)<q(c)?g.insertBefore(c):g.insertAfter(c),l(g))},l=function(a){for(var b=a.closest("ol, ul"),c=b.find("li"),d=c.length,e=0;e<d;++e)if(a[0]===c[e]){i.find("li").attr("value",e+1);break}},m=function(a,b){var c=[];return a.split(",").forEach(function(a){b.split(",").forEach(function(b){c.push(a.trim()+" "+b.trim())})}),c.join(", ")},n=function(a,b){"undefined"!=typeof d.reorderEnd&&d.reorderEnd(g.closest(d.list),g);var c=s();t(f,c)?(new Date).getTime()-e.time<500&&Math.abs(e.x-a)<10&&Math.abs(e.y-b)<10&&g[0].focus():d.reorderDone(g.closest(d.list),g,c),i.remove(),i=null,g.removeClass(d.itemMovingClass),g=null,e=null},o=function(a,b){switch(a.keyCode){case c.space:case c.arrowRight:case c.arrowDown:a.preventDefault(),a.stopPropagation();var d=b.next();d.length&&d.insertBefore(b);break;case c.arrowLeft:case c.arrowUp:a.preventDefault(),a.stopPropagation();var e=b.prev();e.length&&e.insertAfter(b)}},p=function(a){return a.offset().left+a.outerWidth()/2},q=function(a){return a.offset().top+a.outerHeight()/2},r=function(b,c){var d=a(b),e=a(c),f=p(d)-p(e),g=q(d)-q(e);return Math.sqrt(f*f+g*g)},s=function(){return(g||h).closest(d.list).find(d.item).map(function(a,b){return d.idGetter(b)}).get()},t=function(a,b){return a.length===b.length&&a.every(function(a,c){return a===b[c]})};d.itemInPage=m(d.list,d.item),a(d.list).on("mousedown touchstart",d.item,function(a){var c=b.prepare(a);c.start&&j(a,c)}),a(d.list).on("keydown",d.item,function(b){h=a(b.currentTarget).closest(d.itemInPage),f=s(),o(b,h);var c=s();t(f,c)||d.reorderDone(h.closest(d.list),h,c)}),a(d.itemInPage).attr("tabindex","0")}});